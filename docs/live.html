<!docType HTML>
<html lang=en>
<head>
	<meta charset='utf-8'><meta http-equiv='x-ua-compatible' content='ie=edge'>
	<link rel='shortcut icon' href='favicon.ico' />
	<title>sequential.js - live</title>
	<style>
		a {color:#428bca;text-decoration:none;cursor:pointer}
		a:hover,
		a:focus {color:#2a6496;text-decoration:underline}
		#editor { position:fixed;top:0;left:0;right:0;bottom:0;margin:0;padding:0; }
		body { font-family:sans-serif; background-color:#F9F9F9;}
		@media screen and (min-width: 600px) { #editor { position:fixed;top:3px;left:3px;right:3px;bottom:3px;margin:0;padding:0;}
	</style>
</head>
<body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js'></script>
<script>window.ace || document.write('<script src="third-party/ace/1.2.3/ace.js"><\/script>');</script>
<script src='third-party/yeoman/3.2.0/stringifyObject.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js'></script>
<script>window.LZString || document.write('<script src="third-party/lz-string/1.4.4/lz-string.min.js"><\/script>');</script>
<pre id='editor'></pre>
<div style='position:fixed;z-index:1000;bottom:4px;right:4px;font-weight:bold;font-size:11px;' >
    <a target='_top' title='go to sequential.js.org' href='https://sequential.js.org/'>home</a> - 
    <a target='_top' title='get an HTML snippet to embed this code' id='linkEmbed'>embed</a> - 
	<a target='_top' title='run out of the iframe' onclick='this.href=location.href;'>expand</a>
</div>
<script>
var editor = ace.edit('editor');
editor.getSession().setUseWorker(false); // prevent worker to signal warning / errors as you type.
editor.setShowFoldWidgets(false);        // disable autofolding (since code is constantly regenerated this feature would not work nicely)
editor.setTheme('ace/theme/dawn');
editor.getSession().setMode('ace/mode/javascript');
editor.$blockScrolling=Infinity; // required to prevent some console.warn 
editor.renderer.setShowGutter(false); // hide line numbers when using the ace editor		
editor.setShowPrintMargin(true); // I am torn whether we need this or not ?
editor.setFontSize(16);
		
try {
   editor.setValue( LZString.decompressFromEncodedURIComponent(location.hash.substring(1)) );
} catch (e) {
	; // should fail here only if the location.hash can not be decompressed.
}

editor.clearSelection();
editor.focus();

(function() { 
	var nativeConsoleLog = console.log;  
	var loadedURLs={};

	window.load = function(url) {
		if (loadedURLs[url]) { return; }
		loadedURLs[url] = 1;
		var script = document.createElement('script'); 
		script.type  = 'text/javascript';
		script.async = true;
		script.src   = url
		var entry = document.getElementsByTagName('script')[0];
		entry.parentNode.insertBefore(script, entry);	
	};
	
	function commentify(oj) {
		var str = oj+''; 
		if (str.indexOf('\n') == -1) {      // stringify the object only if it is not a multiline string.
			str = stringifyObject(oj, {
				inlineCharacterLimit : 30		
			});
		}
		var array = str.split('\n');
		for (var i=0;i<array.length;i++) {
			array[i] = '//> '+array[i];
			if (array[i].length > 180) { 
				array[i] = array[i].substring(0,177)+'...'; // let's not make any string longer than n chars.
			}
		}
		return '\n'+array.join('\n');
	}
	
	
	(function loopy() {
		function addTail(tail) {
			var code = editor.getValue(); 
			code = code.replace(/\r?\n/g, '\n'); // Making sure that any \r\n becomes \n
			var array = code.split('\n');
			var array2 = [];
			for (var i=0;i<array.length;i++) {
				if (array[i].indexOf('//> ') !== 0) array2.push(array[i]);
			}
			code = array2.join('\n')+ tail;
			var pos = editor.getCursorPosition();
			editor.setValue(code);
			editor.navigateTo(pos.row,pos.column);
		}
		
		if (editor.getSelectedText() == '') {
			addTail('');
			if (editor.getValue() == '') location.replace('live.html#');
			else             	         location.replace('live.html#'+LZString.compressToEncodedURIComponent( editor.getValue() ));
			
			console.log = function(oj) { 
				addTail(commentify(oj));
			};
			try { eval(editor.getValue()); } catch (e) { console.log(''+e); }
			console.log = nativeConsoleLog; 
		}  
		setTimeout(loopy, 1000); 
	})();
})();


// Experimental Feature:
// If during rendering we have the horizontal scrollBar visible we scale the font down. 
//
setTimeout(function() { 
	if (editor.renderer.scrollBarH.isVisible) {
		editor.setFontSize(10);  
	}	
},0); 


//
// Creates a kind of modal dialog showing the HTML to copy/paste to embed the code 
// (in a newly built Ace editor)
// 
document.getElementById('linkEmbed').onclick = function() {
	var blanket = document.createElement('div');
	blanket.style.position = 'fixed';
	blanket.style.top =   0;
	blanket.style.bottom= 0;
	blanket.style.left =  0;
	blanket.style.right = 0;
	blanket.style.backgroundColor ='#ddd';
	blanket.style.opacity = '0.9'
	blanket.style.zIndex = 1000000;
	
	var d =  document.createElement('div');
	d.style.position = 'fixed';
	d.style.border = '1px solid #333';
	d.style.top =   '40px';
	d.style.bottom= '70px';
	d.style.left =  '50px';
	d.style.right = '50px';
	d.style.backgroundColor ='#fff';
	d.style.zIndex = 1000001;
	
	var lnkClose =  document.createElement('a');
	lnkClose.style.position = 'fixed';
	lnkClose.style.bottom= '40px';
	lnkClose.style.left =  '50px';
	lnkClose.style.right = '50px';
	lnkClose.style.zIndex = 1000001;
	lnkClose.style.fontWeight = 'bold';
	lnkClose.style.fontSize = '11px';
	lnkClose.href = '#';
	lnkClose.onclick = function() {
		document.body.removeChild(blanket); 
		document.body.removeChild(d);
		document.body.removeChild(lnkClose);
		ed.destroy(); 
	};
	lnkClose.innerHTML = 'Close dialog';
	var ed = ace.edit(d);
	ed.getSession().setUseWorker(false); 
	ed.setShowFoldWidgets(false);        
	ed.setTheme('ace/theme/dawn');
	ed.getSession().setMode('ace/mode/html');
	ed.$blockScrolling=Infinity;  
	ed.renderer.setShowGutter(false); 		
	ed.setShowPrintMargin(true); 
	ed.setFontSize(12);
	var str = '<!-'+ '- sequential.js can be installed on virtually any website -' +'->\n'+
		      '<!-'+ '- Just Copy/Paste The HTML code below in your page -' +'->\n' +
		      '<!-'+ '- Adjust style parameters as you deem necessary -' +'->\n\n' +
	          '<iframe src="https://sequential.js.org/live.html'+location.hash+'"\n'+
	          'style="border:1px solid #888;\n       margin:0;padding:0;\n       width:500px;height:300px;">\n</iframe>';
	ed.setValue(str);
	document.body.appendChild(blanket); 
	document.body.appendChild(d);
	document.body.appendChild(lnkClose);
	return false;
}

//
// Experimental Feature (not ready)
// 
/*
function snap() {
	var code = editor.getValue(); 
	code = code.replace(/\r?\n/g, '\n'); // Making sure that any \r\n becomes \n
	var array = code.split('\n');
	var max = 0;
	var a1 = []; 
    for (var i=0;i<array.length;i++) {
    	if (array[i].trim() === 0) {
    	    a1.push(array[i]);
    	} else if (array[i].indexOf('//(')===0) {
            var tmp = parseInt(array[i].substring(3))
            if (tmp > max) max = tmp;
            a1.push(array[i]);
        } else {
    		break;
    	}
    }
	var tag = '//('+(max+1)+') '
	a1.push(tag+ ' // '+new Date().toISOString());
	if (window.platform) {
		a1.push(tag+ ' // '+platform.description);		
	} else {
		a1.push(tag+ ' // [???]');
		load('https://cdnjs.cloudflare.com/ajax/libs/platform/1.3.4/platform.min.js'); // <-- this might not necessarily be up. (maybe it should be loaded from sqntl domain)
		var tryCount = 0; 
		setTimeout(function updatePlatform() {
			var code = editor.getValue();
			if (window.platform) {
				code = code.replace(tag+ ' // [???]',tag+ ' // '+platform.description);
				editor.setValue(code);
				return;
			}
			tryCount++; 
			if (tryCount == 6) return; 
			setTimeout(updatePlatform,500); 
		},500); 
	}
	var a2 = [];
	for (;i<array.length;i++) {
		a1.push(tag+' '+array[i]);
		a2.push(array[i]);
	}
	var code = a1.join('\n')+'\n'+a2.join('\n'); 
	editor.setValue(code);
}
*/
</script>
</body>
</html>